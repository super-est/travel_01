<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±äº¬å†¬æ—¥ä¹‹æ—… | Tokyo Travel Planner (Cloud)</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <style>
        body { font-family: 'Noto Sans TC', 'Noto Sans JP', sans-serif; background-color: #F8FAFC; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .gps-pulse {
            width: 14px; height: 14px; border: 2px solid #fff; border-radius: 50%;
            background-color: #3b82f6; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4);
            animation: pulse-blue 2s infinite;
        }
        @keyframes pulse-blue {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        .slide-enter-active, .slide-leave-active { transition: transform 0.3s ease; }
        .slide-enter-from, .slide-leave-to { transform: translateX(-100%); }
        .sync-pulse { animation: sync-pulse 1s infinite; }
        @keyframes sync-pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="text-slate-700 h-screen flex flex-col overflow-hidden">

    <div id="app" class="flex flex-col h-full max-w-md mx-auto w-full bg-white shadow-2xl relative sm:rounded-xl sm:my-4 sm:h-[95vh] sm:border-4 sm:border-slate-100">

        <!-- Header -->
        <header class="bg-indigo-600 text-white shrink-0 z-20 shadow-md">
            <div class="p-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <button @click="showTripMenu = true" class="text-indigo-100 hover:text-white transition">
                        <i class="ph-bold ph-list text-2xl"></i>
                    </button>
                    <div class="overflow-hidden">
                        <h1 class="text-xl font-bold tracking-wide flex items-center gap-2 truncate">
                            {{ setup.destination || 'æ±äº¬è¡Œç¨‹' }} 
                            <i v-if="isSyncing" class="ph-bold ph-arrows-clockwise text-xs sync-pulse"></i>
                        </h1>
                        <p class="text-[10px] text-indigo-100 mt-0.5 font-light tracking-wider truncate">
                            {{ user ? 'é›²ç«¯åŒæ­¥ä¸­' : 'é€£ç·šä¸­...' }} â€¢ {{ currentTripId ? 'ID: ' + currentTripId.slice(-4) : '' }}
                        </p>
                    </div>
                </div>
                <div class="flex items-center gap-2 shrink-0">
                    <div class="flex bg-indigo-800/50 p-1 rounded-lg">
                        <button @click="viewMode = 'plan'" :class="viewMode === 'plan' ? 'bg-white text-indigo-700 shadow-sm' : 'text-indigo-200'" class="p-2 rounded-md transition-all"><i class="ph-bold ph-calendar-check text-lg"></i></button>
                        <button @click="viewMode = 'map'" :class="viewMode === 'map' ? 'bg-white text-indigo-700 shadow-sm' : 'text-indigo-200'" class="p-2 rounded-md transition-all"><i class="ph-bold ph-map-trifold text-lg"></i></button>
                        <button @click="viewMode = 'money'" :class="viewMode === 'money' ? 'bg-white text-indigo-700 shadow-sm' : 'text-indigo-200'" class="p-2 rounded-md transition-all"><i class="ph-bold ph-currency-dollar text-lg"></i></button>
                    </div>
                </div>
            </div>
            
            <div class="flex overflow-x-auto hide-scroll px-3 pb-3 space-x-3 snap-x">
                <div v-for="(day, index) in days" :key="index" @click="currentDayIdx = index" class="snap-center shrink-0 flex flex-col items-center justify-center min-w-[64px] h-16 rounded-2xl cursor-pointer transition-all border-2" :class="currentDayIdx === index ? 'bg-white text-indigo-600 border-white shadow-lg scale-105' : 'bg-indigo-500/50 text-indigo-100 border-transparent hover:bg-indigo-500'">
                    <span class="text-[10px] font-medium opacity-80">{{ day.shortDate }}</span>
                    <span class="text-lg font-bold">D{{ index + 1 }}</span>
                </div>
                <button @click="addDay" class="shrink-0 w-12 h-16 rounded-2xl flex items-center justify-center border-2 border-indigo-400 border-dashed text-indigo-200 hover:text-white hover:border-white transition"><i class="ph-bold ph-plus"></i></button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-slate-50 relative hide-scroll">
            
            <!-- è¡Œç¨‹è¡¨ (Plan View) -->
            <transition name="fade" mode="out-in">
                <div v-if="viewMode === 'plan'" :key="currentDayIdx" class="p-4 pb-24">
                    <div class="bg-white p-5 rounded-3xl shadow-sm mb-6 border border-slate-100">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h2 class="text-2xl font-black text-slate-800">{{ currentDay.date }}</h2>
                                <p class="text-indigo-500 font-bold text-sm mt-1 flex items-center gap-1">
                                    <i class="ph-fill ph-calendar"></i> {{ currentDay.title || 'ä»Šæ—¥ä¸»é¡Œ' }}
                                </p>
                            </div>
                            <div v-if="weatherDisplay" class="text-right bg-slate-50 p-2 rounded-2xl border border-slate-100">
                                <div class="flex items-center justify-end gap-1 text-indigo-600">
                                    <i :class="['ph-duotone', weatherDisplay.icon, 'text-xl']"></i>
                                    <span class="text-lg font-bold font-mono">{{ weatherDisplay.temp }}</span>
                                </div>
                                <div class="text-[9px] text-slate-400 mt-0.5">{{ weatherDisplay.label }}</div>
                            </div>
                        </div>
                        <input v-model="currentDay.title" @change="saveToCloud" class="w-full text-xs text-slate-400 bg-transparent border-b border-dashed border-slate-200 focus:border-indigo-400 focus:outline-none py-1" placeholder="ç·¨è¼¯ä»Šæ—¥ä¸»é¡Œ...">
                    </div>

                    <div class="relative pl-6 border-l-2 border-indigo-100 space-y-8 ml-2">
                        <div v-for="(item, idx) in (currentDay.items || [])" :key="idx" class="relative group">
                            <div class="absolute -left-[35px] top-3 flex items-center justify-center">
                                <div class="w-4 h-4 rounded-full border-4 border-white shadow-md z-10" :class="getDotColor(item.type)"></div>
                            </div>
                            
                            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all">
                                <div class="flex gap-4">
                                    <div class="flex flex-col items-center w-16 shrink-0 gap-2">
                                        <div class="relative flex flex-col items-center justify-center bg-slate-50 rounded-xl p-1 w-full h-14 border border-slate-100">
                                            <span class="text-[9px] font-bold text-slate-400">{{ getTimePeriod(item.time) }}</span>
                                            <span class="text-lg font-black text-slate-700 leading-none font-mono">{{ item.time || '--:--' }}</span>
                                            <input v-model="item.time" @change="saveToCloud" type="time" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                                        </div>
                                        <select v-model="item.type" @change="saveToCloud" class="text-[9px] bg-slate-50 border-none rounded-lg py-1 px-1 w-full text-center font-bold">
                                            <option value="spot">ğŸ“ æ™¯é»</option>
                                            <option value="food">ğŸ´ ç¾é£Ÿ</option>
                                            <option value="shop">ğŸ›ï¸ è³¼ç‰©</option>
                                            <option value="transport">ğŸš‡ äº¤é€š</option>
                                        </select>
                                    </div>

                                    <div class="flex-1 min-w-0">
                                        <input v-model="item.activity" @change="saveToCloud" class="block w-full font-bold text-slate-800 bg-transparent border-none p-0 focus:ring-0 text-lg" placeholder="è¡Œç¨‹åç¨±...">
                                        <div class="flex items-center gap-1 mt-1">
                                            <i class="ph-fill ph-map-pin text-indigo-400 text-xs"></i>
                                            <input v-model="item.location" @change="saveToCloud" class="flex-1 text-xs text-slate-500 bg-transparent border-none p-0 focus:ring-0 truncate" placeholder="åœ°é»...">
                                        </div>
                                        <div class="flex items-center gap-1 mt-2 bg-amber-50 p-1.5 rounded-lg border border-amber-100">
                                            <i class="ph-bold ph-note-pencil text-amber-500 text-xs"></i>
                                            <input v-model="item.note" @change="saveToCloud" class="flex-1 text-[11px] text-amber-700 bg-transparent border-none p-0 focus:ring-0" placeholder="å‚™è¨»...">
                                        </div>
                                    </div>

                                    <div class="flex flex-col justify-between">
                                        <button @click="removeItem(idx)" class="text-slate-300 hover:text-red-500 transition"><i class="ph-bold ph-trash text-lg"></i></button>
                                        <a :href="getGoogleMapLink(item.location)" target="_blank" class="bg-indigo-50 text-indigo-600 p-2 rounded-xl hover:bg-indigo-100 transition"><i class="ph-bold ph-navigation-arrow"></i></a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button @click="addItem" class="w-full py-4 border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 hover:border-indigo-400 hover:text-indigo-500 transition flex items-center justify-center gap-2">
                            <i class="ph-bold ph-plus-circle text-xl"></i>
                            <span class="font-bold text-sm">æ–°å¢è¡Œç¨‹é …ç›®</span>
                        </button>
                    </div>
                </div>
            </transition>

            <!-- åœ°åœ–è¦–åœ– -->
            <div v-if="viewMode === 'map'" class="h-full flex flex-col relative">
                <div id="map" class="flex-1 w-full h-full bg-slate-200 z-0"></div>
                <div class="absolute bottom-6 left-4 right-4 bg-white/90 backdrop-blur rounded-2xl p-4 shadow-xl border border-white/50 z-10 flex justify-between items-center">
                    <div>
                        <div class="text-xs font-bold text-slate-400 uppercase mb-1">ä»Šæ—¥æ¢éšª</div>
                        <div class="text-lg font-black text-slate-800">{{ (currentDay.items || []).filter(i=>i.location).length }} å€‹åœ°é»</div>
                    </div>
                    <div class="flex gap-2">
                        <button @click="initMap" class="p-3 bg-indigo-100 text-indigo-600 rounded-xl hover:bg-indigo-200"><i class="ph-bold ph-arrows-clockwise text-xl"></i></button>
                        <button @click="centerOnUser" class="p-3 bg-indigo-600 text-white rounded-xl shadow-lg shadow-indigo-200"><i class="ph-bold ph-crosshair text-xl"></i></button>
                    </div>
                </div>
            </div>

            <!-- è¨˜å¸³è¦–åœ– -->
            <div v-if="viewMode === 'money'" class="p-4 pb-24">
                <div class="bg-gradient-to-br from-indigo-600 to-blue-500 text-white rounded-3xl p-6 shadow-xl mb-6 text-center">
                    <div class="text-indigo-100 text-sm font-medium mb-1">ç¸½é ç®—æ”¯å‡º (JPY)</div>
                    <div class="text-5xl font-black font-mono mb-2">Â¥{{ totalExpense.toLocaleString() }}</div>
                    <div class="inline-flex items-center bg-white/20 px-4 py-1.5 rounded-full text-sm font-bold backdrop-blur-sm">
                        â‰ˆ NT$ {{ Math.round(totalExpense * exchangeRate).toLocaleString() }}
                    </div>
                </div>
                
                <div class="bg-white rounded-3xl shadow-sm p-5 border border-slate-100 mb-6">
                    <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="ph-fill ph-plus-circle text-indigo-500"></i> æ–°å¢æ”¯å‡º</h3>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <input v-model="newExpense.item" placeholder="é …ç›®å…§å®¹" class="bg-slate-50 border-none rounded-xl text-sm px-4 py-3">
                        <input v-model.number="newExpense.amount" type="number" placeholder="é‡‘é¡ (Â¥)" class="bg-slate-50 border-none rounded-xl text-sm px-4 py-3 font-mono">
                    </div>
                    <div class="flex gap-3">
                        <select v-model="newExpense.payer" class="flex-1 bg-slate-50 border-none rounded-xl text-sm px-4 py-3">
                            <option v-for="p in participants" :value="p">{{ p }} æ”¯ä»˜</option>
                        </select>
                        <button @click="addExpense" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-indigo-100 active:scale-95 transition">åŠ å…¥</button>
                    </div>
                </div>

                <div class="space-y-3">
                    <div v-for="(exp, idx) in expenses" :key="idx" class="flex justify-between items-center bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-indigo-50 flex items-center justify-center text-indigo-600 font-bold">{{ exp.payer.charAt(0) }}</div>
                            <div>
                                <div class="font-bold text-slate-800 text-sm">{{ exp.item }}</div>
                                <div class="text-[10px] text-slate-400">ç”± {{ exp.payer }} æ”¯ä»˜</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-mono font-black text-slate-700 text-lg">Â¥{{ exp.amount.toLocaleString() }}</span>
                            <button @click="removeExpense(idx)" class="text-slate-300 hover:text-red-400"><i class="ph-fill ph-x-circle text-xl"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- å´é‚Šæ¬„ -->
        <transition name="slide">
            <div v-if="showTripMenu" class="fixed inset-0 z-50 flex">
                <div class="bg-white w-4/5 max-w-xs h-full shadow-2xl flex flex-col relative z-50 p-6">
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-2xl font-black text-slate-800">å¤šäººé›²ç«¯å”ä½œ</h2>
                        <button @click="showTripMenu = false" class="text-slate-400 hover:text-slate-600"><i class="ph-bold ph-x text-2xl"></i></button>
                    </div>

                    <div v-if="currentTripId" class="mb-8 p-4 bg-indigo-50 rounded-2xl border border-indigo-100">
                        <div class="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-2">æ‚¨çš„è¡Œç¨‹ä»£ç¢¼ (åˆ†äº«çµ¦æ—…ä¼´)</div>
                        <div class="flex items-center justify-between">
                            <code class="text-lg font-mono font-bold text-indigo-700 tracking-tighter">{{ currentTripId }}</code>
                            <button @click="copyTripId" class="p-2 bg-white rounded-lg text-indigo-600 shadow-sm active:scale-90 transition"><i class="ph-bold ph-copy"></i></button>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <button @click="createNewTrip" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg shadow-indigo-100 flex items-center justify-center gap-2 transition">
                            <i class="ph-bold ph-plus-circle text-xl"></i> å»ºç«‹æ–°æ—…ç¨‹
                        </button>
                        
                        <div class="border-t border-slate-100 pt-4 mt-4">
                            <div class="text-[10px] font-black text-slate-400 uppercase mb-2">åŠ å…¥æ—…ä¼´çš„è¡Œç¨‹</div>
                            <div class="flex gap-2">
                                <input v-model="joinId" placeholder="è¼¸å…¥è¡Œç¨‹ ID" class="flex-1 bg-slate-50 border-none rounded-xl text-xs px-4 py-3">
                                <button @click="joinTrip" class="bg-indigo-100 text-indigo-600 px-4 rounded-xl font-bold"><i class="ph-bold ph-arrow-right"></i></button>
                            </div>
                        </div>
                    </div>

                    <div class="mt-auto border-t border-slate-100 pt-6">
                        <div class="text-xs font-bold text-slate-400 uppercase mb-4 tracking-widest">æœ€è¿‘ç€è¦½</div>
                        <div class="space-y-3 max-h-[30vh] overflow-y-auto hide-scroll">
                            <div v-for="trip in (tripList || [])" :key="trip.id" @click="switchTrip(trip.id)" class="p-4 rounded-2xl border transition cursor-pointer relative group" :class="currentTripId === trip.id ? 'bg-indigo-50 border-indigo-200 shadow-sm' : 'bg-slate-50 border-transparent'">
                                <div class="font-bold text-slate-800 truncate">{{ trip.destination }}</div>
                                <div class="text-[10px] text-slate-400 mt-1">ID: {{ trip.id.slice(-6) }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex-1 bg-slate-900/60 backdrop-blur-sm z-40" @click="showTripMenu = false"></div>
            </div>
        </transition>

        <!-- åˆå§‹è¨­å®š -->
        <div v-if="showSetupModal" class="absolute inset-0 bg-indigo-800/95 backdrop-blur-md z-[55] flex items-center justify-center p-6">
            <div class="bg-white w-full max-w-sm rounded-[40px] p-8 shadow-2xl text-center">
                <div class="w-20 h-20 bg-indigo-100 rounded-3xl flex items-center justify-center mx-auto mb-6 rotate-3">
                    <i class="ph-duotone ph-cloud-arrow-up text-4xl text-indigo-600"></i>
                </div>
                <h2 class="text-3xl font-black text-slate-800 mb-2">é›²ç«¯ä¹‹æ—…</h2>
                <p class="text-sm text-slate-400 mb-8">å»ºç«‹ 2/15 çš„å°ˆå±¬é›²ç«¯è¡Œç¨‹</p>
                <div class="space-y-4 text-left">
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase ml-2 mb-1">ç›®çš„åœ°</label>
                        <input v-model="setup.destination" type="text" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-5 py-4 font-bold text-slate-700">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-[10px] font-black text-slate-400 ml-2 mb-1">é–‹å§‹æ—¥æœŸ</label><input v-model="setup.startDate" type="date" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-4 py-4 text-sm font-bold"></div>
                        <div><label class="block text-[10px] font-black text-slate-400 ml-2 mb-1">ç¸½å¤©æ•¸</label><input v-model.number="setup.days" type="number" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-5 py-4 font-black text-center"></div>
                    </div>
                </div>
                <button @click="initTrip" class="w-full bg-indigo-600 text-white font-black py-5 rounded-[24px] shadow-xl mt-8 flex items-center justify-center gap-2">
                    ç«‹å³å»ºç«‹ <i class="ph-bold ph-arrow-right"></i>
                </button>
            </div>
        </div>

    </div>

    <script type="module">
        import { createApp, ref, computed, watch, onMounted, nextTick } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js'
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js'
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, updateDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js'

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'tokyo-travel-app';

        createApp({
            setup() {
                const user = ref(null);
                const isSyncing = ref(false);
                const viewMode = ref('plan');
                const currentDayIdx = ref(0);
                const showTripMenu = ref(false);
                const showSetupModal = ref(false);
                const joinId = ref('');
                
                const tripList = ref([]);
                const currentTripId = ref(null);
                
                const days = ref([]);
                const expenses = ref([]);
                const participants = ref(['æˆ‘', 'æ—…ä¼´']);
                const exchangeRate = ref(0.215);
                const newExpense = ref({ item: '', amount: '', payer: 'æˆ‘' });
                const weather = ref({ daily: null });
                const setup = ref({ destination: 'Tokyo', startDate: '2026-02-15', days: 5 });

                const currentDay = computed(() => (days.value && days.value[currentDayIdx.value]) || {items:[], date:'', title:''});
                const totalExpense = computed(() => (expenses.value || []).reduce((sum, item) => sum + (item.amount || 0), 0));

                const weatherDisplay = computed(() => {
                    const daily = weather.value.daily;
                    if (!currentDay.value.fullDate || !daily || !daily.time) {
                        return { temp: '--', icon: 'ph-sun', label: 'è®€å–ä¸­...' };
                    }
                    const idx = daily.time.indexOf(currentDay.value.fullDate);
                    if (idx !== -1 && daily.temperature_2m_min && daily.temperature_2m_max) {
                        return { 
                            temp: `${Math.round(daily.temperature_2m_min[idx])}Â°-${Math.round(daily.temperature_2m_max[idx])}Â°`, 
                            icon: 'ph-cloud-sun', 
                            label: 'æ±äº¬å¤©æ°£' 
                        };
                    }
                    return { temp: '--', icon: 'ph-sun', label: 'æš«ç„¡å¤©æ°£è³‡æ–™' };
                });

                // --- é›²ç«¯åŒæ­¥é‚è¼¯ ---
                const saveToCloud = async () => {
                    if (!user.value || !currentTripId.value) return;
                    isSyncing.value = true;
                    try {
                        const tripRef = doc(db, 'artifacts', appId, 'public', 'data', 'trips', currentTripId.value);
                        await setDoc(tripRef, {
                            days: days.value,
                            expenses: expenses.value,
                            setup: setup.value,
                            updatedAt: new Date()
                        }, { merge: true });
                    } catch (e) {
                        console.error("åŒæ­¥å¤±æ•—", e);
                    } finally {
                        setTimeout(() => isSyncing.value = false, 500);
                    }
                };

                const joinTrip = async () => {
                    if (!joinId.value) return;
                    const tripRef = doc(db, 'artifacts', appId, 'public', 'data', 'trips', joinId.value);
                    const snap = await getDoc(tripRef);
                    if (snap.exists()) {
                        currentTripId.value = joinId.value;
                        const data = snap.data();
                        days.value = data.days || [];
                        expenses.value = data.expenses || [];
                        setup.value = data.setup || setup.value;
                        
                        const tripMeta = { id: joinId.value, destination: setup.value.destination };
                        if (!tripList.value.find(t => t.id === joinId.value)) {
                            tripList.value.unshift(tripMeta);
                            localStorage.setItem('trip_list', JSON.stringify(tripList.value));
                        }
                        
                        showTripMenu.value = false;
                        bindCloudUpdates(joinId.value);
                    } else {
                        alert("æ‰¾ä¸åˆ°è©²è¡Œç¨‹ ID");
                    }
                };

                let unsubscribe = null;
                const bindCloudUpdates = (id) => {
                    if (unsubscribe) unsubscribe();
                    const tripRef = doc(db, 'artifacts', appId, 'public', 'data', 'trips', id);
                    unsubscribe = onSnapshot(tripRef, (doc) => {
                        if (doc.exists() && !isSyncing.value) {
                            const data = doc.data();
                            days.value = data.days || [];
                            expenses.value = data.expenses || [];
                            setup.value = data.setup || setup.value;
                        }
                    }, (error) => console.error("ç›£è½å¤±æ•—", error));
                };

                const initTrip = async () => {
                    const newId = 'T' + Math.random().toString(36).substr(2, 6).toUpperCase();
                    const start = new Date(setup.value.startDate);
                    const newDays = [];
                    const dNames = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
                    for(let i=0; i<setup.value.days; i++) {
                        const curr = new Date(start); curr.setDate(start.getDate() + i);
                        const y = curr.getFullYear(), m = curr.getMonth() + 1, d = curr.getDate();
                        const fullDate = `${y}-${m < 10 ? '0'+m : m}-${d < 10 ? '0'+d : d}`;
                        newDays.push({ date: `${m}/${d} (${dNames[curr.getDay()]})`, shortDate: `${m}/${d}`, fullDate: fullDate, title: i === 0 ? 'å°å¹´å¤œãƒ»å•Ÿç¨‹' : 'æ±äº¬è¡Œç¨‹', items: [] });
                    }
                    days.value = newDays;
                    currentTripId.value = newId;
                    
                    const tripMeta = { id: newId, destination: setup.value.destination };
                    tripList.value.unshift(tripMeta);
                    localStorage.setItem('trip_list', JSON.stringify(tripList.value));
                    
                    await saveToCloud();
                    bindCloudUpdates(newId);
                    showSetupModal.value = false;
                };

                const switchTrip = (id) => {
                    currentTripId.value = id;
                    showTripMenu.value = false;
                    bindCloudUpdates(id);
                };

                const copyTripId = () => {
                    const el = document.createElement('textarea');
                    el.value = currentTripId.value;
                    document.body.appendChild(el);
                    el.select();
                    document.execCommand('copy');
                    document.body.removeChild(el);
                    alert("å·²è¤‡è£½è¡Œç¨‹ IDï¼Œå‚³çµ¦æ—…ä¼´å³å¯åŠ å…¥ï¼");
                };

                // --- åŸºç¤åŠŸèƒ½ ---
                const addItem = () => { 
                    if (!currentDay.value.items) currentDay.value.items = [];
                    currentDay.value.items.push({ time: '', type: 'spot', activity: '', location: '', note: '' }); 
                    saveToCloud(); 
                };
                const removeItem = (idx) => { if(confirm('åˆªé™¤é …ç›®ï¼Ÿ')) { currentDay.value.items.splice(idx, 1); saveToCloud(); } };
                const addExpense = () => { if(newExpense.value.item && newExpense.value.amount) { if(!expenses.value) expenses.value = []; expenses.value.unshift({...newExpense.value}); newExpense.value.item=''; newExpense.value.amount=''; saveToCloud(); }};
                const removeExpense = (idx) => { expenses.value.splice(idx, 1); saveToCloud(); };
                const getDotColor = (t) => t==='food'?'bg-amber-400':t==='shop'?'bg-pink-400':t==='transport'?'bg-blue-400':'bg-indigo-500';
                const getTimePeriod = (t) => { if(!t) return 'æ™‚é–“'; const h=parseInt(t.split(':')[0]); return h<12?'ä¸Šåˆ':'ä¸‹åˆ'; };
                const getGoogleMapLink = (loc) => loc ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}` : '#';

                let mapInstance;
                const initMap = async () => { await nextTick(); if (mapInstance) mapInstance.remove(); mapInstance = L.map('map').setView([35.6895, 139.6917], 13); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance); };

                onMounted(async () => {
                    const initAuth = async () => {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } 
                        else { await signInAnonymously(auth); }
                    };
                    await initAuth();
                    onAuthStateChanged(auth, (u) => { 
                        user.value = u;
                        const list = localStorage.getItem('trip_list');
                        if(list) {
                            try {
                                tripList.value = JSON.parse(list) || [];
                            } catch (e) { tripList.value = []; }
                            
                            if(tripList.value.length > 0) switchTrip(tripList.value[0].id);
                            else showSetupModal.value = true;
                        } else showSetupModal.value = true;
                    });
                    
                    fetch(`https://api.open-meteo.com/v1/forecast?latitude=35.6895&longitude=139.6917&daily=temperature_2m_max,temperature_2m_min&timezone=auto&start_date=2026-02-15&end_date=2026-02-28`)
                        .then(r=>r.json())
                        .then(d=>weather.value.daily = d.daily)
                        .catch(e => console.error("å¤©æ°£ç²å–å¤±æ•—", e));
                });

                watch(viewMode, (v) => { if(v === 'map') initMap(); });

                return {
                    user, isSyncing, viewMode, currentDayIdx, days, currentDay, expenses, newExpense, totalExpense,
                    showTripMenu, showSetupModal, setup, tripList, currentTripId, weatherDisplay, joinId,
                    initTrip, switchTrip, joinTrip, addItem, removeItem, addExpense, removeExpense,
                    getDotColor, getTimePeriod, getGoogleMapLink, initMap, copyTripId, saveToCloud,
                    createNewTrip: () => { showSetupModal.value = true; showTripMenu.value = false; },
                    addDay: () => { 
                        if (!days.value || days.value.length === 0) return;
                        const last = new Date(days.value[days.value.length-1].fullDate);
                        last.setDate(last.getDate()+1);
                        const mm = last.getMonth()+1, dd = last.getDate();
                        days.value.push({ date: `${mm}/${dd} (${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][last.getDay()]})`, shortDate: `${mm}/${dd}`, fullDate: last.toISOString().split('T')[0], title: 'æ–°è¡Œç¨‹', items: [] });
                        saveToCloud();
                    }
                };
            }
        }).mount('#app')
    </script>
</body>
</html>